var ImageCropper=function(){"use strict";function e(e,t,n,i,o){void 0===t&&(t=!1),void 0===n&&(n={}),void 0===i&&(i=null),void 0===o&&(o=!1);var r=o?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return i&&i.appendChild(r),t&&(Array.isArray(t)?t:[t]).forEach(function(e){return r.classList.add(e)}),Object.keys(n||{}).forEach(function(e){return r.setAttribute(e,n[e])}),r}function t(e){return"HTMLElement"in window?!!(e&&e instanceof HTMLElement):!(!e||"object"!=typeof e||1!==e.nodeType||!e.nodeName)}function n(e){var t=null;try{t=new CustomEvent(e)}catch(n){t=document.createEvent("CustomEvent");t.initCustomEvent(e,!0,!0,null)}return t}function i(e,t){var n=e.clientX-t.left,i=e.clientY-t.top;return{x:n<0?0:n>t.width?t.width:n,y:i<0?0:i>t.height?t.height:i}}function o(e){return Object.keys(e).reduce(function(t,n){return t.push(e[n]),t},[])}function r(e,t){return!(-1===(Array.isArray(e)?e:o(e)).indexOf(t))}function s(e,t){Object.keys(t||{}).forEach(function(n){return e[n]=t[n]})}function a(e,t){var n=~~(.5*(t.x2-t.x)),i=~~(.5*(t.y2-t.y));e.x-n<0&&(e.x=n),e.x+n>t.w&&(e.x=t.w-n),e.y-i<0&&(e.y=i),e.y+i>t.h&&(e.y=t.h-i),s(t,{x:e.x-n,x2:e.x+n,y:e.y-i,y2:e.y+i})}function c(e,t){var n=m.OFFLINE,i=Object.seal(Object.defineProperties({$$parent:null,el_content:null,el_handles:null,el_overlay:null,meta:{dimensions:{x:0,x2:0,y:0,y2:0,w:0,h:0},ratio:{w:1,h:1}},options:{update_cb:function(){},create_cb:function(){},destroy_cb:function(){},min_crop_width:100,min_crop_height:100,max_width:500,max_height:500,fixed_size:!1,mode:p.SQUARE}},{state:{get:function(){return n},set:function(e){n=e,i.$$parent&&i.$$parent.setAttribute("data-imgc-state",e)}}}));return s(i.options,t),f[e]=Object.seal(i),i}function d(){var e=f[this.$$id];if(e.state===m.LOADING){var t=e.el_content.$$source,n=t.naturalWidth,i=t.naturalHeight,o=e.options,r=o.max_width,a=o.max_height;if(n>r&&(i=~~(r*i/n),n=r),i>a&&(n=~~(a*n/i),i=a),e.meta.ratio={w:Math.round(t.naturalWidth/n*100)/100,h:Math.round(t.naturalHeight/i*100)/100},e.meta.dimensions.w=t.width=n,e.meta.dimensions.h=t.height=i,e.state=m.READY,e.options.fixed_size){var c=e.options,d=c.min_crop_width,h=c.min_crop_height,p=.5*(d>h?d:h);s(e.meta.dimensions,{x:.5*n-p,x2:.5*n+p,y:.5*i-p,y2:.5*i+p})}else s(e.meta.dimensions,{x2:n,y2:i});u.call(this),e.options.create_cb({w:n,h:i})}}function u(e){var t=f[this.$$id];if(t.state===m.READY){e&&e.stopPropagation();var n=t.meta,i=n.dimensions;i.x<0&&(i.x=0),i.y<0&&(i.y=0),i.x2>i.w&&(i.x2=i.w),i.y2>i.h&&(i.y2=i.h),t.el_overlay.update(i,t.options),t.el_handles.update(i,t.options),t.options.update_cb(i)}}var h=function(t){var i=this;this.$$view=e("div",["imgc-content"],{},t.$$parent),this.$$source=e("img",null,{},this.$$view),this.$$source.addEventListener("load",function(){var e=n("source:fetched");i.$$source.dispatchEvent(e)})};h.prototype.source=function(e){this.$$source.src=e};var m={OFFLINE:0,LOADING:1,READY:2},p={SQUARE:"square",CIRCULAR:"circular"},v=Object.freeze([function(e,t,n){var i=t.x;v[7](e,t,n),n.fixed_size?t.y+t.x-i<0?(t.x=i-t.y,t.y=0):t.y+=t.x-i:v[4](e,t,n)},function(e,t,n){var i=t.x2;v[5](e,t,n),n.fixed_size?t.y-t.x2+i<0?(t.x2=i+t.y,t.y=0):t.y-=t.x2-i:v[4](e,t,n)},function(e,t,n){var i=t.x2;v[5](e,t,n),n.fixed_size?t.y2+t.x2-i>t.h?(t.x2=i+(t.h-t.y2),t.y2=t.h):t.y2+=t.x2-i:v[6](e,t,n)},function(e,t,n){var i=t.x;v[7](e,t,n),n.fixed_size?t.y2+(i-t.x)>t.h?(t.x=i-(t.h-t.y2),t.y2=t.h):t.y2-=t.x-i:v[6](e,t,n)},function(e,t,n){return t.y=t.y2-e.y<n.min_crop_height?t.y2-n.min_crop_height:e.y},function(e,t,n){return t.x2=e.x-t.x<n.min_crop_width?t.x+n.min_crop_width:e.x},function(e,t,n){return t.y2=e.y-t.y<n.min_crop_height?t.y+n.min_crop_height:e.y},function(e,t,n){return t.x=t.x2-e.x<n.min_crop_width?t.x2-n.min_crop_width:e.x}]),$=function(t,o,r){function s(e){e.stopPropagation(),document.addEventListener("mouseup",a),document.addEventListener("mousemove",c)}function a(e){e.stopPropagation(),document.removeEventListener("mouseup",a),document.removeEventListener("mousemove",c)}function c(e){e.stopPropagation(),v[o](i(e,r.$$parent.getBoundingClientRect()),r.meta.dimensions,r.options);var s=n("source:dimensions");t.dispatchEvent(s)}this.$$view=e("span",["imgc-handles-el","imgc-handles-el-"+~~(o/4)+"-"+o%4],{},t),this.$$view.addEventListener("mousedown",s)},l=function(t){function o(e){document.addEventListener("mousemove",s),document.addEventListener("mouseup",c),d(e)}function s(e){d(e)}function c(){document.removeEventListener("mouseup",c),document.removeEventListener("mousemove",s)}function d(e){a(i(e,t.$$parent.getBoundingClientRect()),t.meta.dimensions);var o=n("source:dimensions");t.$$parent.dispatchEvent(o)}var u=this;if(!r(p,t.options.mode))throw new TypeError("Mode "+t.options.mode+" doesnt exist");this.$$view=e("div",["imgc-handles","imgc-handles-"+t.options.mode],{},t.$$parent);for(var h=0;h<(t.options.fixed_size?4:8);h++)new $(u.$$view,h,t);this.$$view.addEventListener("mousedown",o)};l.prototype.update=function(e){var t=e.x,n=e.x2,i=e.y,o=e.y2,r=e.w,a=e.h;s(this.$$view.style,{top:i+"px",left:t+"px",right:~~(r-n)+"px",bottom:~~(a-o)+"px"})};var y=function(t){this.$$view=e("svg",["imgc-overlay"],{},t.$$parent,!0),this.$$path=e("path",null,{"fill-rule":"evenodd"},this.$$view,!0)};y.prototype.update=function(e,t){var n=e.x,i=e.x2,o=e.y,r=e.y2,s=e.w,a=e.h,c=t.mode,d=.5*(i-n),u=.5*(r-o),h=i-n,m=r-o;this.$$path.setAttribute("d","M 0 0 v "+a+" h "+s+" v "+-a+" H-0zM"+(c===p.SQUARE?n+" "+o+" h "+h+" v "+m+" h "+-h+" V "+-m+" z":n+.5*h+" "+(o+.5*m)+" m "+-d+",0 a "+d+", "+u+" 0 1,0 "+h+",0 a "+d+", "+u+" 0 1,0 "+-h+" ,0 z"))};var f={},x=function(e,n,i){if(void 0===i&&(i={}),n&&e){this.$$id=Math.random().toString(36).substring(2);var o=c(this.$$id,i),r=document.querySelector(e);if(!t(r))throw new TypeError("Does the parent exist?");o.$$parent=r,o.$$parent.classList.add("imgc"),o.$$parent.addEventListener("DOMNodeRemovedFromDocument",this.destroy.bind(this)),o.$$parent.addEventListener("source:fetched",d.bind(this),!0),o.$$parent.addEventListener("source:dimensions",u.bind(this),!0),o.el_content=new h(o),o.el_overlay=new y(o),o.el_handles=new l(o),this.setImage(n)}};return x.prototype.setImage=function(e){var t=f[this.$$id];t.state=m.LOADING,t.el_content.source(e)},x.prototype.destroy=function(){var e=f[this.$$id];if(e.state=m.OFFLINE,t(e.$$parent)){for(;e.$$parent.firstChild;)e.$$parent.removeChild(e.$$parent.firstChild);e.$$parent.classList.remove("imgc")}e.options.destroy_cb(),delete f[this.$$id]},x.prototype.crop=function(t,n){void 0===t&&(t="image/jpeg"),void 0===n&&(n=1);var i=f[this.$$id];t=r(["image/jpeg","image/png"],t)?"image/jpeg":t,n=n<0||n>1?1:n;var o=i.meta.dimensions,s=o.x,a=o.y,c=o.x2,d=o.y2,u=i.meta.ratio,h=u.w,m=u.h,p=c-s,v=d-a,$=e("canvas",null,{width:p,height:v}),l=h*s,y=m*a,x=h*p,g=m*v;return console.log(l,y,x,g),0===l&&(l=1,x-=l),0===y&&(y=1,g-=y+.1),console.log(l,y,x,g),$.getContext("2d").drawImage(i.el_content.$$source,l,y,x,g,0,0,p,v),$.toDataURL(t,n)},x}();
