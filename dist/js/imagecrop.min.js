var ImageCropper=function(){"use strict";function t(t,e,n,i,o){void 0===e&&(e=!1),void 0===n&&(n={}),void 0===i&&(i=null),void 0===o&&(o=!1);var r=o?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);return i&&i.appendChild(r),e&&(Array.isArray(e)?e:[e]).forEach(function(t){return r.classList.add(t)}),Object.keys(n||{}).forEach(function(t){return r.setAttribute(t,n[t])}),r}function e(t){return"HTMLElement"in window?!!(t&&t instanceof HTMLElement):!(!t||"object"!=typeof t||1!==t.nodeType||!t.nodeName)}function n(t){var e=null;try{e=new CustomEvent(t)}catch(n){e=document.createEvent("CustomEvent");e.initCustomEvent(t,!0,!0,null)}return e}function i(t,e){var n=t.clientX-e.left,i=t.clientY-e.top;return{x:n<0?0:n>e.width?e.width:n,y:i<0?0:i>e.height?e.height:i}}function o(t){return Object.keys(t).reduce(function(e,n){return e.push(t[n]),e},[])}function r(t,e){return!(-1===(Array.isArray(t)?t:o(t)).indexOf(e))}function s(t,e){Object.keys(e||{}).forEach(function(n){return t[n]=e[n]})}function a(t,e){var n=~~(.5*(e.x2-e.x)),i=~~(.5*(e.y2-e.y));t.x-n<0&&(t.x=n),t.x+n>e.w&&(t.x=e.w-n),t.y-i<0&&(t.y=i),t.y+i>e.h&&(t.y=e.h-i),s(e,{x:t.x-n,x2:t.x+n,y:t.y-i,y2:t.y+i})}function c(t,e){var n=p.OFFLINE,i=Object.seal(Object.defineProperties({$$parent:null,el_content:null,el_handles:null,el_overlay:null,meta:{dimensions:{x:0,x2:0,y:0,y2:0,w:0,h:0},ratio:{w:1,h:1}},options:{update_cb:function(){},create_cb:function(){},destroy_cb:function(){},min_crop_width:100,min_crop_height:100,max_width:500,max_height:500,fixed_size:!1,mode:m.SQUARE}},{state:{get:function(){return n},set:function(t){n=t,i.$$parent&&i.$$parent.setAttribute("data-imgc-state",t)}}}));return s(i.options,e),f[t]=Object.seal(i),i}function u(){var t=f[this.$$id];if(t.state===p.LOADING){var e=t.el_content.$$source,n=e.naturalWidth,i=e.naturalHeight,o=t.options,r=o.max_width,a=o.max_height;if(n>r&&(i=~~(r*i/n),n=r),i>a&&(n=~~(a*n/i),i=a),t.meta.ratio={w:Math.round(e.naturalWidth/n*100)/100,h:Math.round(e.naturalHeight/i*100)/100},t.meta.dimensions.w=e.width=n,t.meta.dimensions.h=e.height=i,t.state=p.READY,t.options.fixed_size){var c=t.options,u=c.min_crop_width,h=c.min_crop_height,m=.5*(u>h?u:h);s(t.meta.dimensions,{x:.5*n-m,x2:.5*n+m,y:.5*i-m,y2:.5*i+m})}else s(t.meta.dimensions,{x2:n,y2:i});d.call(this),t.options.create_cb({w:n,h:i})}}function d(t){var e=f[this.$$id];if(e.state===p.READY){t&&t.stopPropagation();var n=e.meta,i=n.dimensions;i.x<0&&(i.x=0),i.y<0&&(i.y=0),i.x2>i.w&&(i.x2=i.w),i.y2>i.h&&(i.y2=i.h),e.el_overlay.update(i,e.options),e.el_handles.update(i,e.options),e.options.update_cb(i)}}var h=function(e){var i=this;this.$$view=t("div",["imgc-content"],{},e.$$parent),this.$$source=t("img",null,{},this.$$view),this.$$source.addEventListener("load",function(){var t=n("source:fetched");i.$$source.dispatchEvent(t)})};h.prototype.source=function(t){this.$$source.src=t};var p={OFFLINE:0,LOADING:1,READY:2},m={SQUARE:"square",CIRCULAR:"circular"},v=Object.freeze([function(t,e,n){var i=e.x;v[7](t,e,n),n.fixed_size?e.y+e.x-i<0?(e.x=i-e.y,e.y=0):e.y+=e.x-i:v[4](t,e,n)},function(t,e,n){var i=e.x2;v[5](t,e,n),n.fixed_size?e.y-e.x2+i<0?(e.x2=i+e.y,e.y=0):e.y-=e.x2-i:v[4](t,e,n)},function(t,e,n){var i=e.x2;v[5](t,e,n),n.fixed_size?e.y2+e.x2-i>e.h?(e.x2=i+(e.h-e.y2),e.y2=e.h):e.y2+=e.x2-i:v[6](t,e,n)},function(t,e,n){var i=e.x;v[7](t,e,n),n.fixed_size?e.y2+(i-e.x)>e.h?(e.x=i-(e.h-e.y2),e.y2=e.h):e.y2-=e.x-i:v[6](t,e,n)},function(t,e,n){return e.y=e.y2-t.y<n.min_crop_height?e.y2-n.min_crop_height:t.y},function(t,e,n){return e.x2=t.x-e.x<n.min_crop_width?e.x+n.min_crop_width:t.x},function(t,e,n){return e.y2=t.y-e.y<n.min_crop_height?e.y+n.min_crop_height:t.y},function(t,e,n){return e.x=e.x2-t.x<n.min_crop_width?e.x2-n.min_crop_width:t.x}]),$=function(e,o,r){function s(t){t.stopPropagation(),document.addEventListener("mouseup",a),document.addEventListener("mousemove",c)}function a(t){t.stopPropagation(),document.removeEventListener("mouseup",a),document.removeEventListener("mousemove",c)}function c(t){t.stopPropagation(),v[o](i(t,r.$$parent.getBoundingClientRect()),r.meta.dimensions,r.options);var s=n("source:dimensions");e.dispatchEvent(s)}this.$$view=t("span",["imgc-handles-el","imgc-handles-el-"+~~(o/4)+"-"+o%4],{},e),this.$$view.addEventListener("mousedown",s)},l=function(e){function o(t){document.addEventListener("mousemove",s),document.addEventListener("mouseup",c),u(t)}function s(t){u(t)}function c(){document.removeEventListener("mouseup",c),document.removeEventListener("mousemove",s)}function u(t){a(i(t,e.$$parent.getBoundingClientRect()),e.meta.dimensions);var o=n("source:dimensions");e.$$parent.dispatchEvent(o)}var d=this;if(!r(m,e.options.mode))throw new TypeError("Mode "+e.options.mode+" doesnt exist");this.$$view=t("div",["imgc-handles","imgc-handles-"+e.options.mode],{},e.$$parent);for(var h=0;h<(e.options.fixed_size?4:8);h++)new $(d.$$view,h,e);this.$$view.addEventListener("mousedown",o)};l.prototype.update=function(t){var e=t.x,n=t.x2,i=t.y,o=t.y2,r=t.w,a=t.h;s(this.$$view.style,{top:i+"px",left:e+"px",right:~~(r-n)+"px",bottom:~~(a-o)+"px"})};var y=function(e){this.$$view=t("svg",["imgc-overlay"],{},e.$$parent,!0),this.$$path=t("path",null,{"fill-rule":"evenodd"},this.$$view,!0)};y.prototype.update=function(t,e){var n=t.x,i=t.x2,o=t.y,r=t.y2,s=t.w,a=t.h,c=e.mode,u=.5*(i-n),d=.5*(r-o),h=i-n,p=r-o;this.$$path.setAttribute("d","M 0 0 v "+a+" h "+s+" v "+-a+" H-0zM"+(c===m.SQUARE?n+" "+o+" h "+h+" v "+p+" h "+-h+" V "+-p+" z":n+.5*h+" "+(o+.5*p)+" m "+-u+",0 a "+u+", "+d+" 0 1,0 "+h+",0 a "+u+", "+d+" 0 1,0 "+-h+" ,0 z"))};var f={},x=function(t,n,i){if(void 0===i&&(i={}),n&&t){this.$$id=Math.random().toString(36).substring(2);var o=c(this.$$id,i),r=document.querySelector(t);if(!e(r))throw new TypeError("Does the parent exist?");o.$$parent=r,o.$$parent.classList.add("imgc");new MutationObserver(this.destroy.bind(this)).observe(o.$$parent,{attributes:!1,childList:!0,characterData:!1}),o.$$parent.addEventListener("source:fetched",u.bind(this),!0),o.$$parent.addEventListener("source:dimensions",d.bind(this),!0),o.el_content=new h(o),o.el_overlay=new y(o),o.el_handles=new l(o),this.setImage(n)}};return x.prototype.setImage=function(t){var e=f[this.$$id];e.state=p.LOADING,e.el_content.source(t)},x.prototype.destroy=function(){var t=f[this.$$id];if(t.state=p.OFFLINE,e(t.$$parent)){for(;t.$$parent.firstChild;)t.$$parent.removeChild(t.$$parent.firstChild);t.$$parent.classList.remove("imgc")}t.options.destroy_cb(),delete f[this.$$id]},x.prototype.crop=function(e,n){void 0===e&&(e="image/jpeg"),void 0===n&&(n=1),console.log("crop");var i=f[this.$$id];e=r(["image/jpeg","image/png"],e)?"image/jpeg":e,n=n<0||n>1?1:n;var o=i.meta.dimensions,s=o.x,a=o.y,c=o.x2,u=o.y2,d=i.meta.ratio,h=d.w,p=d.h,m=c-s,v=u-a,$=t("canvas",null,{width:m,height:v});return $.getContext("2d").drawImage(i.el_content.$$source,h*s,p*a,h*m,p*v,0,0,m,v),$.toDataURL(e,n)},x}();
